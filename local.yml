--- 
- hosts: localhost
  connection: local
  become: true

  tasks:
    - name: install packages
      ansible.builtin.apt:
        pkg:
          - apache2-utils

    - name: traefik container
      community.docker.docker_container:
        name: traefik
        image: traefik:v2.2
        restart_policy: always
        recreate: true
        # networks:
          # - name: web
        exposed_ports:
          - 80
          - 443
          - 8080
        volumes:
          - ~/.ansible/pull/{{ ansible_facts["nodename"] }}/traefik/traefik.yml:/etc/traefik/traefik.yml
          - ~/.ansible/pull/{{ ansible_facts["nodename"] }}/traefik/fileConfig.yml:/etc/traefik/fileConfig.yml

    # - name: authelia container
    #   community.docker.docker_container:
    #     name: authelia
    #     image: authelia/authelia
    #     restart_policy: always
    #     networks:
    #       - name: web
    #     exposed_ports:
    #       - 80
    #       - 443
    #     environment:
    #       - TZ=America/Denver
    #     volumes_from:
    #       - ~/.ansible/pull/{{ ansible_facts["nodename"] }}/traefik.toml:/traefik.toml 
    #       - ~/.ansible/pull/{{ ansible_facts["nodename"] }}/traefik_dynamic.toml:/traefik_dynamic.toml 
    #       - ~/.ansible/pull/{{ ansible_facts["nodename"] }}/acme.json:/acme.json 

    - name: installs tailscale
      ansible.builtin.shell:
        cmd: |
          curl -fsSL https://tailscale.com/install.sh | sh

  roles:
    - role: hifis.unattended_upgrades
      vars:
        unattended_origins_patterns:
          - origin=Ubuntu,archive=${distro_codename}-security
          - origin=Ubuntu,a=${distro_codename}-updates
        systemd_timer_OnCalendar: "*:0/30"

    - role: dwsr.ansible_pull
      vars:
        ansible_pull_playbook: local.yml
        ansible_pull_inventory: none.yml
        ansible_pull_repo_url: git@github.com:legitcamper/homelab-proxy.git
