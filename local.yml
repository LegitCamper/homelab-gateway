---
- hosts: localhost
  connection: local
  become: true

  tasks:
    - name: install packages
      apt:
        name: "{{ item }}"
        update_cache: yes
        install_recommends: no
        force: yes
        dpkg_options: 'force-confdef,force-confold'
        state: latest
      loop:
        - webhook
        # - golang
        # - docker.io
        # - apt-config-auto-update
        # - unattended-upgrades

    - name: installs, logs in, and setups tailscale
      shell: |
          set timeout 30
          curl -fsSL https://tailscale.com/install.sh | sh
          tailscale login --authkey=$(</root/tailscaleapikey.txt)
          tailscale up --hostname=homelab-proxy
          exit 0
      args:
        executable: /bin/bash

    - name: get traefik configs
      shell: |
        mkdir /etc/traefik
        wget https://raw.githubusercontent.com/LegitCamper/homelab-proxy/main/traefik/traefik.toml -O /etc/traefik/traefik.toml
        wget https://raw.githubusercontent.com/LegitCamper/homelab-proxy/main/traefik/dynamic.toml -O /etc/traefik/dynamic.toml

    - name: install traefik
      shell: |
        cd /tmp
        wget https://github.com/traefik/traefik/releases/download/v2.9.6/traefik_v2.9.6_linux_amd64.tar.gz -O traefik.tar.gz
        tar xzvf traefik.tar.gz
        mv traefik /bin/traefik
        rm traefik.tar.gz

    # - name: Start unattended upgrades
      # service:
        # name: unattended-upgrades
        # enabled: true 
        # state: started
        # daemon_reload: yes        

    - name: remove used port 53 
      shell: |
        if [ $(cat /etc/systemd/resolved.conf.d/DigitalOcean.conf | wc -l) < 3 ]
        then
          echo "DNSStubListener=no" >> /etc/systemd/resolved.conf.d/adguardhome.conf
        fi

        systemctl reload-or-restart systemd-resolved

    - name: get webhooks
      shell: |
        wget https://raw.githubusercontent.com/LegitCamper/homelab-proxy/main/hooks.json -O /root/hooks.json
        string=s/mysecret/$(</root/webhooksecret.txt)/g
        sed -i $string /root/hooks.json
      args:
        executable: /bin/bash

    - name: copy ansible-pull service
      shell: |
        wget https://raw.githubusercontent.com/LegitCamper/homelab-proxy/main/ansible-pull.service -O /etc/systemd/system/ansible-pull.service
        wget https://raw.githubusercontent.com/LegitCamper/homelab-proxy/main/ansible-pull.sh -O /root/ansible-pull.sh
        chmod +x /root/ansible-pull.sh

    - name: Start ansible-pull service, if not started
      service:
        name: ansible-pull
        enabled: true 
        state: started
        daemon_reload: yes

    - name: copy traefik service
      shell: wget https://raw.githubusercontent.com/LegitCamper/homelab-proxy/main/traefik.service -O /etc/systemd/system/traefik.service

    - name: Start traefik service, if not started
      service:
        name: traefik
        enabled: true 
        state: started
        daemon_reload: yes

    - name: Restart traefik and reload config
      service:
        name: traefik
        enabled: true 
        state: restarted
        daemon_reload: yes